<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mon Chatbot AI - TP 5 Final</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .chat-container { height: calc(100vh - 220px); }
        .message-user { background-color: #3b82f6; color: white; align-self: flex-end; border-radius: 12px 12px 0 12px; }
        .message-bot { background-color: #f3f4f6; color: #1f2937; align-self: flex-start; border-radius: 12px 12px 12px 0; }
        .message-content { white-space: pre-wrap; word-break: break-word; }
        
        .typing-dots span {
            width: 8px; height: 8px; background-color: #3b82f6;
            display: inline-block; border-radius: 50%;
            animation: bounce 1.4s infinite ease-in-out both;
        }
        .typing-dots span:nth-child(1) { animation-delay: -0.32s; }
        .typing-dots span:nth-child(2) { animation-delay: -0.16s; }
        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1.0); }
        }
        .magic-btn { transition: all 0.3s ease; font-size: 0.75rem; }
        .magic-btn:hover { transform: translateY(-2px); filter: brightness(1.1); }
    </style>
</head>
<body class="bg-gray-100 font-sans">

    <div class="max-w-2xl mx-auto mt-6 bg-white shadow-xl rounded-lg overflow-hidden border border-gray-200">
        <!-- Header -->
        <div class="bg-blue-600 p-4 text-white text-center relative">
            <h1 class="text-xl font-bold">Mon Chatbot IA (TP 5)</h1>
            <p class="text-sm opacity-80" id="model-status">Mode Haute Disponibilité</p>
            <button onclick="summarizeChat()" class="absolute right-4 top-4 bg-white/20 hover:bg-white/30 text-xs py-1 px-2 rounded-md magic-btn border border-white/30">
                ✨ Résumer
            </button>
        </div>

        <!-- Chat Box -->
        <div id="chat-box" class="chat-container p-4 overflow-y-auto flex flex-col space-y-4 bg-gray-50">
            <div class="message-bot p-3 max-w-[80%] shadow-sm">
                <div class="message-content">Bonjour ! Ce chatbot est maintenant configuré avec un mode de secours pour éviter les saturations d'OpenRouter.</div>
            </div>
        </div>

        <!-- Toolbar -->
        <div class="px-4 py-2 bg-gray-50 border-t flex space-x-2 overflow-x-auto">
            <button onclick="improveMessage()" class="magic-btn whitespace-nowrap bg-purple-100 text-purple-700 border border-purple-200 px-3 py-1 rounded-full flex items-center">
                ✨ Reformuler Pro
            </button>
            <button onclick="suggestTopic()" class="magic-btn whitespace-nowrap bg-indigo-100 text-indigo-700 border border-indigo-200 px-3 py-1 rounded-full flex items-center">
                ✨ Idée de sujet
            </button>
        </div>

        <!-- Input Area -->
        <div class="p-4 bg-white border-t border-gray-200 flex items-center space-x-2">
            <input type="text" id="user-input" placeholder="Tapez votre message..." 
                   class="flex-1 border border-gray-300 rounded-full px-5 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
            <button onclick="sendMessage()" id="send-btn" 
                    class="bg-blue-600 text-white p-2 rounded-full hover:bg-blue-700 transition flex items-center justify-center w-10 h-10">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                    <path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.429A1 1 0 009 15.571V11a1 1 0 112 0v4.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z" />
                </svg>
            </button>
        </div>
    </div>

    <script>
        const apiKey = ""; // API Gemini interne (Canvas)
        const OPENROUTER_API_KEY = "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"; 
        
        const chatBox = document.getElementById('chat-box');
        const userInput = document.getElementById('user-input');
        const sendBtn = document.getElementById('send-btn');
        let chatHistory = [];

        userInput.addEventListener("keypress", (e) => { if (e.key === "Enter") sendMessage(); });

        // Fonction pour appeler Gemini (très stable)
        async function callGemini(prompt, systemPrompt = "Tu es un assistant IA utile.") {
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            try {
                const response = await fetch(url, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }] }],
                        systemInstruction: { parts: [{ text: systemPrompt }] }
                    })
                });
                const data = await response.json();
                return data.candidates?.[0]?.content?.parts?.[0]?.text;
            } catch (e) { return null; }
        }

        async function improveMessage() {
            const text = userInput.value.trim();
            if (!text) return;
            userInput.disabled = true;
            const improved = await callGemini(text, "Reformule ce message pour qu'il soit poli et professionnel. Ne réponds que par le message reformulé.");
            if (improved) userInput.value = improved.trim();
            userInput.disabled = false;
        }

        async function summarizeChat() {
            if (chatHistory.length < 2) return;
            const historyText = chatHistory.map(m => `${m.role}: ${m.content}`).join("\n");
            const summary = await callGemini(`Résume notre conversation :\n${historyText}`, "Fais un résumé très court de 2 lignes.");
            if (summary) appendMessage(`✨ Résumé : ${summary}`, 'bot');
        }

        async function suggestTopic() {
            const suggestion = await callGemini("Donne moi un sujet de test pour un chatbot.", "Juste une phrase courte.");
            if (suggestion) userInput.value = suggestion.trim();
        }

        async function sendMessage() {
            const text = userInput.value.trim();
            if (!text) return;

            appendMessage(text, 'user');
            chatHistory.push({role: "user", content: text});
            userInput.value = "";
            
            const loadingId = appendLoadingIndicator();
            setLoading(true);

            // TENTATIVE 1 : Gemini Direct (Plus stable)
            let botReply = await callGemini(text, "Réponds de manière concise.");
            
            if (botReply) {
                removeLoadingIndicator(loadingId);
                appendMessage(botReply, 'bot');
                chatHistory.push({role: "assistant", content: botReply});
                document.getElementById('model-status').innerText = "Mode: Gemini Ultra-Stable";
            } else {
                // TENTATIVE 2 : OpenRouter (Backup)
                try {
                    const response = await fetch("https://openrouter.ai/api/v1/chat/completions", {
                        method: "POST",
                        headers: {
                            "Authorization": `Bearer ${OPENROUTER_API_KEY}`,
                            "Content-Type": "application/json",
                            "HTTP-Referer": window.location.origin
                        },
                        body: JSON.stringify({
                            "model": "google/gemini-2.0-flash-lite-preview-02-05:free",
                            "messages": chatHistory.slice(-4)
                        })
                    });
                    const data = await response.json();
                    if (data.choices?.[0]) {
                        removeLoadingIndicator(loadingId);
                        botReply = data.choices[0].message.content;
                        appendMessage(botReply, 'bot');
                        chatHistory.push({role: "assistant", content: botReply});
                        document.getElementById('model-status').innerText = "Mode: OpenRouter Backup";
                    } else {
                        throw new Error();
                    }
                } catch (e) {
                    removeLoadingIndicator(loadingId);
                    appendMessage("Désolé, tous les serveurs IA sont saturés. Réessayez dans quelques secondes.", 'bot');
                }
            }
            setLoading(false);
        }

        function appendMessage(text, sender) {
            const div = document.createElement('div');
            div.className = sender === 'user' ? 'message-user p-3 max-w-[80%] shadow-sm' : 'message-bot p-3 max-w-[80%] shadow-sm';
            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            contentDiv.innerText = text;
            div.appendChild(contentDiv);
            chatBox.appendChild(div);
            chatBox.scrollTo({ top: chatBox.scrollHeight, behavior: 'smooth' });
        }

        function appendLoadingIndicator() {
            const id = 'loading-' + Date.now();
            const div = document.createElement('div');
            div.id = id;
            div.className = 'message-bot p-3 max-w-[80%] shadow-sm flex items-center space-x-1';
            div.innerHTML = `<div class="typing-dots"><span></span><span></span><span></span></div>`;
            chatBox.appendChild(div);
            chatBox.scrollTo({ top: chatBox.scrollHeight, behavior: 'smooth' });
            return id;
        }

        function removeLoadingIndicator(id) {
            const el = document.getElementById(id);
            if (el) el.remove();
        }

        function setLoading(isLoading) {
            sendBtn.disabled = isLoading;
            sendBtn.style.opacity = isLoading ? '0.5' : '1';
        }
    </script>
</body>
</html>
